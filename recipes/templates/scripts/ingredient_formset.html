<script>
    document.addEventListener('DOMContentLoaded', () => {
        const formsetContainer = document.getElementById('ingredient-formset-container');
        const addButton = document.getElementById('add-ingredient-button');
        const totalForms = document.getElementById('id_ingredient_set-TOTAL_FORMS');
        const formPrefix = 'ingredient_set';

        const emptyFormTemplate = document.createElement('div');
        emptyFormTemplate.innerHTML = `
            <div class="ingredient-form bg-gray-50 p-4 rounded-lg shadow-inner flex items-end justify-between gap-4">
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 w-full">
                    <div>
                        <label for="id_${formPrefix}-__prefix__-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" name="${formPrefix}-__prefix__-name" id="id_${formPrefix}-__prefix__-name" class="w-full px-4 py-3 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Flour">
                    </div>
                    <div>
                        <label for="id_${formPrefix}-__prefix__-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" name="${formPrefix}-__prefix__-quantity" id="id_${formPrefix}-__prefix__-quantity" step="0.01" class="w-full px-4 py-3 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 2.5">
                    </div>
                    <div>
                        <label for="id_${formPrefix}-__prefix__-unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select name="${formPrefix}-__prefix__-unit" id="id_${formPrefix}-__prefix__-unit" class="w-full px-4 py-3 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">---------</option>
                            <option value="g">Grams</option>
                            <option value="kg">Kilograms</option>
                            <option value="ml">Milliliters</option>
                            <option value="l">Liters</option>
                            <option value="cup">Cups</option>
                            <option value="tbsp">Tablespoons</option>
                            <option value="tsp">Teaspoons</option>
                            <option value="pcs">Piece(s)</option>
                        </select>
                    </div>
                    <div>
                        <label for="id_${formPrefix}-__prefix__-optional" class="flex items-center text-sm font-medium text-gray-700 mb-1">
                            <input type="checkbox" name="${formPrefix}-__prefix__-optional" id="id_${formPrefix}-__prefix__-optional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-2">Optional</span>
                        </label>
                    </div>
                    <input type="hidden" name="${formPrefix}-__prefix__-id" id="id_${formPrefix}-__prefix__-id">
                </div>
                <button type="button" class="remove-ingredient-button text-sm font-medium text-red-600 cursor-pointer">
                    Remove
                </button>
            </div>
        `;

        const updateElementIndex = (el, prefix, index) => {
            const idRegex = new RegExp(`(${prefix}-(\\d+|__prefix__)-)`);
            const replacement = `${prefix}-${index}-`;
            if (el.id) {
                el.id = el.id.replace(idRegex, replacement);
            }
            if (el.name) {
                el.name = el.name.replace(idRegex, replacement);
            }
            if (el.htmlFor) {
                el.htmlFor = el.htmlFor.replace(idRegex, replacement);
            }
        };

        const reindexForms = () => {
            const forms = formsetContainer.querySelectorAll('.ingredient-form');
            forms.forEach((form, index) => {
                const elements = form.querySelectorAll('input, select, textarea, label');
                elements.forEach(el => updateElementIndex(el, formPrefix, index));
            });
            totalForms.value = forms.length;
        };
        
        addButton.addEventListener('click', () => {
            const formCount = formsetContainer.querySelectorAll('.ingredient-form').length;
            const newForm = emptyFormTemplate.querySelector('.ingredient-form').cloneNode(true);
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formCount);
            formsetContainer.appendChild(newForm);
            totalForms.value = formCount + 1;
        });

        formsetContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-ingredient-button')) {
                const formToRemove = event.target.closest('.ingredient-form');
                formToRemove.remove();
                reindexForms();
            }
        });

        const applyStyles = () => {
            const ingredientFields = formsetContainer.querySelectorAll('input:not([type="checkbox"]):not([type="hidden"]), select');
            ingredientFields.forEach(field => {
                field.classList.add('w-full', 'px-4', 'py-3', 'border', 'border-gray-400', 'rounded-md', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-indigo-500');
            });
        };
        applyStyles();
        const observer = new MutationObserver(applyStyles);
        observer.observe(formsetContainer, { childList: true, subtree: true });

        const textInputs = document.querySelectorAll(
            '#id_title, #id_cuisine, #id_difficulty, #id_veg_type, #id_prep_time, #id_total_time, #id_calories'
        );
        const instructionsField = document.querySelector('#id_instructions');

        const mainInputClass = 'w-full px-4 py-3 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500';

        textInputs.forEach(field => {
            field.classList.add(...mainInputClass.split(' '));
        });

        if (instructionsField) {
            instructionsField.classList.add('w-full', 'px-4', 'py-3', 'border', 'border-gray-400', 'rounded-md', 'h-40', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-indigo-500');
        }
    });
</script>
